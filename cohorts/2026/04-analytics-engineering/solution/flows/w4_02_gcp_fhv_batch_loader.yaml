id: w4_02_gcp_fhv_batch_loader
namespace: zoomcamp
description: Batch loader for NYC taxi data across months for a specific year.

inputs:
  - id: year
    type: SELECT
    displayName: Select year
    values: ["2019", "2020", "2021"]
    defaults: "2019"
    allowCustomValue: true

tasks:
  - id: for_each_month
    type: io.kestra.plugin.core.flow.ForEach
    values: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"]
    tasks:
      - id: load_data
        type: io.kestra.plugin.core.flow.Subflow
        namespace: zoomcamp
        flowId: w4_01_gcp_fhv
        wait: true  # Wait for subflow completion before proceeding
        transmitFailed: true  # Propagate failures from subflow
        inputs:
          year: "{{ inputs.year }}"
          month: "{{ taskrun.value }}"

pluginDefaults:
  - type: io.kestra.plugin.gcp
    values:
      serviceAccount: "{{kv('GCP_CREDS')}}"
      projectId: "{{kv('GCP_PROJECT_ID')}}"
      location: "{{kv('GCP_LOCATION')}}"
      bucket: "{{kv('GCP_BUCKET_NAME')}}"